// ========================================
// –°—Ç—Ä–∞–Ω–∏—Ü–∞ –Ω–æ–≤–æ—Å—Ç–µ–π –≤ —Å—Ç–∏–ª–µ Telegram
// ========================================

// –î–∞–Ω–Ω—ã–µ –Ω–æ–≤–æ—Å—Ç–µ–π —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –≤–∏–¥–µ–æ
// –î–æ–±–∞–≤—å—Ç–µ —Å–≤–æ–∏ –Ω–æ–≤–æ—Å—Ç–∏ –≤ —ç—Ç–æ—Ç –º–∞—Å—Å–∏–≤
const newsData = [
  {
    id: 1,
    title: '–ó–æ–ª–æ—Ç–∞—è –∏ –±—Ä–æ–Ω–∑–æ–≤–∞—è –Ω–∞–≥—Ä–∞–¥—ã –¥–ª—è –ö—ã—Ä–≥—ã–∑—Å—Ç–∞–Ω–∞ üá∞üá¨',
    excerpt: '–ù–∞—à–∞ —Å—Ç—É–¥–µ–Ω—Ç–∫–∞ ”®–º“Ø—Ä–±–µ–∫–æ–≤–∞ –ê–ª—Ç—ã–Ω–∞–π –∏–∑ –≥—Ä—É–ø–ø—ã –ö–ò–Ø-22 –∑–∞–≤–æ–µ–≤–∞–ª–∞ –∑–æ–ª–æ—Ç—É—é –∏ –±—Ä–æ–Ω–∑–æ–≤—É—é –º–µ–¥–∞–ª–∏ –Ω–∞ –ø–µ—Ä–≤–µ–Ω—Å—Ç–≤–µ –º–∏—Ä–∞ –ø–æ –∞—Ä–º—Ä–µ—Å—Ç–ª–∏–Ω–≥—É –≤ –ë–æ–ª–≥–∞—Ä–∏–∏.',
    content: `–ó–æ–ª–æ—Ç–∞—è –∏ –±—Ä–æ–Ω–∑–æ–≤–∞—è –Ω–∞–≥—Ä–∞–¥—ã –¥–ª—è –ö—ã—Ä–≥—ã–∑—Å—Ç–∞–Ω–∞ üá∞üá¨üá∞üá¨üá∞üá¨

–í –ë–æ–ª–≥–∞—Ä–∏–∏ –Ω–∞ –ø–µ—Ä–≤–µ–Ω—Å—Ç–≤–µ –º–∏—Ä–∞ –ø–æ –∞—Ä–º—Ä–µ—Å—Ç–ª–∏–Ω–≥—É –Ω–∞—à–∞ —Å—Ç—É–¥–µ–Ω—Ç–∫–∞ –∏–∑ –≥—Ä—É–ø–ø—ã –ö–ò–Ø-22 ”®–º“Ø—Ä–±–µ–∫–æ–≤–∞ –ê–ª—Ç—ã–Ω–∞–π –≤–ø–∏—Å–∞–ª–∞ —Å–≤–æ—ë –∏–º—è –≤ –∏—Å—Ç–æ—Ä–∏—é. ü•≥üá∞üá¨

–û–Ω–∞ –∑–∞–≤–æ–µ–≤–∞–ª–∞ –∑–æ–ª–æ—Ç—É—é –º–µ–¥–∞–ª—å –Ω–∞ –ª–µ–≤—É—é —Ä—É–∫—É –∏ —Å—Ç–∞–ª–∞ –±—Ä–æ–Ω–∑–æ–≤—ã–º –ø—Ä–∏–∑—ë—Ä–æ–º –Ω–∞ –ø—Ä–∞–≤—É—é —Ä—É–∫—É –≤ –≤–µ—Å–æ–≤–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –¥–æ 45 –∫–≥.

–ê–ª—Ç—ã–Ω–∞–π –ø–æ–∑–¥—Ä–∞–≤–ª—è–µ–º —Å –ø–æ–±–µ–¥–æ–π –≤ –º–∏—Ä–æ–≤–æ–º –ø–µ—Ä–≤–µ–Ω—Å—Ç–≤–µ! –¢—ã –ø–æ–∫–∞–∑–∞–ª–∞ –Ω–µ–≤–µ—Ä–æ—è—Ç–Ω—É—é —Å–∏–ª—É –¥—É—Ö–∞ –∏ –º–∞—Å—Ç–µ—Ä—Å—Ç–≤–æ. –ñ–µ–ª–∞–µ–º, —á—Ç–æ–±—ã —ç—Ç–∞ –ø–æ–±–µ–¥–∞ —Å—Ç–∞–ª–∞ —Å—Ç–∞—Ä—Ç–æ–º –¥–ª—è –µ—â–µ –±–æ–ª–µ–µ –≥—Ä–∞–Ω–¥–∏–æ–∑–Ω—ã—Ö —Å–≤–µ—Ä—à–µ–Ω–∏–π, –∞ –∑–¥–æ—Ä–æ–≤—å–µ –∏ –≤–µ—Ä–∞ –≤ —Å–µ–±—è –≤—Å–µ–≥–¥–∞ –±—ã–ª–∏ —Ç–≤–æ–∏–º–∏ —Å–ø—É—Ç–Ω–∏–∫–∞–º–∏!

–ò–ì–£ –∫–æ–ª–ª–µ–¥–∂ –≥–æ—Ä–¥–∏—Ç—Å—è —Å–≤–æ–µ–π —Å–ø–æ—Ä—Ç—Å–º–µ–Ω–∫–æ–π.`,
    media: {
      type: 'image',
      url: 'assets/images/news/WhatsApp Image 2025-12-17 at 14.13.00.jpeg'
    },
    date: '17 –¥–µ–∫–∞–±—Ä—è 2025'
  }
];

// ========================================
// –°–∏—Å—Ç–µ–º–∞ –ø–æ–¥—Å—á—ë—Ç–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤
// ========================================

class ViewsCounter {
  constructor() {
    this.storageKey = 'news_views';
    this.sessionKey = 'news_viewed_session';
    this.initStorage();
  }

  initStorage() {
    if (!localStorage.getItem(this.storageKey)) {
      const initialViews = {};
      newsData.forEach(news => {
        initialViews[news.id] = this.getRandomInitialViews();
      });
      localStorage.setItem(this.storageKey, JSON.stringify(initialViews));
    }
  }

  getRandomInitialViews() {
    return Math.floor(Math.random() * 500) + 100;
  }

  getViews(newsId) {
    const views = JSON.parse(localStorage.getItem(this.storageKey) || '{}');
    return views[newsId] || 0;
  }

  incrementViews(newsId) {
    const sessionViewed = JSON.parse(sessionStorage.getItem(this.sessionKey) || '[]');
    
    if (!sessionViewed.includes(newsId)) {
      const views = JSON.parse(localStorage.getItem(this.storageKey) || '{}');
      views[newsId] = (views[newsId] || 0) + 1;
      localStorage.setItem(this.storageKey, JSON.stringify(views));
      
      sessionViewed.push(newsId);
      sessionStorage.setItem(this.sessionKey, JSON.stringify(sessionViewed));
      
      return views[newsId];
    }
    
    return this.getViews(newsId);
  }

  formatViews(count) {
    if (count >= 1000000) {
      return (count / 1000000).toFixed(1).replace('.0', '') + 'M';
    }
    if (count >= 1000) {
      return (count / 1000).toFixed(1).replace('.0', '') + 'K';
    }
    return count.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
  }
}

const viewsCounter = new ViewsCounter();

// ========================================
// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã
// ========================================

document.addEventListener('DOMContentLoaded', () => {
  renderNewsFeed();
  setupModalHandlers();
  setupIntersectionObserver();
});

// ========================================
// –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –ª–µ–Ω—Ç—ã –Ω–æ–≤–æ—Å—Ç–µ–π
// ========================================

function renderNewsFeed() {
  const feed = document.getElementById('news-feed');
  
  feed.innerHTML = newsData.map((news, index) => {
    const views = viewsCounter.getViews(news.id);
    const formattedViews = viewsCounter.formatViews(views);
    
    return `
      <article class="news-post" data-id="${news.id}" style="animation-delay: ${index * 0.1}s">
        <div class="news-post-media">
          ${renderMedia(news.media, true)}
        </div>
        <div class="news-post-body">
          <h2 class="news-post-title">${news.title}</h2>
          <p class="news-post-text">${news.excerpt}</p>
          <div class="news-post-meta">
            <span class="news-post-date">${news.date}</span>
            <span class="news-post-views">
              <span class="views-icon">üëÅ</span>
              <span class="views-count">${formattedViews}</span>
            </span>
          </div>
        </div>
      </article>
    `;
  }).join('');

  feed.querySelectorAll('.news-post').forEach(post => {
    post.addEventListener('click', () => {
      const newsId = parseInt(post.dataset.id);
      openNewsModal(newsId);
    });
  });
}

// ========================================
// –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –º–µ–¥–∏–∞ (–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ/–≤–∏–¥–µ–æ)
// ========================================

function renderMedia(media, isLazy = false) {
  if (media.type === 'video') {
    return `
      <video 
        ${isLazy ? 'preload="none"' : 'preload="metadata"'}
        ${media.poster ? `poster="${media.poster}"` : ''}
        controls
        ${isLazy ? 'loading="lazy"' : ''}
      >
        <source src="${media.url}" type="video/mp4">
        –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤–∏–¥–µ–æ.
      </video>
    `;
  }
  
  return `
    <img 
      src="${media.url}" 
      alt="–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–æ–≤–æ—Å—Ç–∏"
      ${isLazy ? 'loading="lazy"' : ''}
    >
  `;
}

// ========================================
// –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
// ========================================

function openNewsModal(newsId) {
  const news = newsData.find(n => n.id === newsId);
  if (!news) return;

  const newViews = viewsCounter.incrementViews(newsId);
  const formattedViews = viewsCounter.formatViews(newViews);

  const modal = document.getElementById('news-modal');
  const mediaContainer = document.getElementById('news-modal-media');
  const title = document.getElementById('news-modal-title');
  const content = document.getElementById('news-modal-content');
  const date = document.getElementById('news-modal-date');
  const viewsElement = document.querySelector('#news-modal-views .views-count');

  mediaContainer.innerHTML = renderMedia(news.media, false);
  title.textContent = news.title;
  content.textContent = news.content;
  date.textContent = news.date;
  viewsElement.textContent = formattedViews;

  // –ë–ª–æ–∫–∏—Ä—É–µ–º –ø—Ä–æ–∫—Ä—É—Ç–∫—É —Ñ–æ–Ω–∞
  const scrollbarWidth = window.innerWidth - document.documentElement.clientWidth;
  document.body.style.overflow = 'hidden';
  document.body.style.paddingRight = scrollbarWidth + 'px';
  
  modal.classList.add('active');
  // –°–∫—Ä–æ–ª–ª–∏–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∫ –≤–µ—Ä—Ö—É
  modal.scrollTop = 0;

  updatePostViews(newsId, formattedViews);
}

function updatePostViews(newsId, formattedViews) {
  const post = document.querySelector(`.news-post[data-id="${newsId}"]`);
  if (post) {
    const viewsCount = post.querySelector('.views-count');
    if (viewsCount) {
      viewsCount.textContent = formattedViews;
    }
  }
}

// ========================================
// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
// ========================================

function setupModalHandlers() {
  const modal = document.getElementById('news-modal');
  const closeBtn = document.getElementById('close-news-modal');
  const backdrop = document.getElementById('modal-backdrop');

  const closeModal = () => {
    modal.classList.remove('active');
    document.body.style.overflow = '';
    document.body.style.paddingRight = '';
    
    const video = modal.querySelector('video');
    if (video) {
      video.pause();
    }
  };

  if (closeBtn) {
    closeBtn.addEventListener('click', closeModal);
  }

  if (backdrop) {
    backdrop.addEventListener('click', closeModal);
  }

  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && modal.classList.contains('active')) {
      closeModal();
    }
  });
}

// ========================================
// Intersection Observer –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–π
// ========================================

function setupIntersectionObserver() {
  const options = {
    root: null,
    rootMargin: '0px',
    threshold: 0.1
  };

  const observer = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        entry.target.style.animationPlayState = 'running';
        observer.unobserve(entry.target);
      }
    });
  }, options);

  document.querySelectorAll('.news-post').forEach(post => {
    post.style.animationPlayState = 'paused';
    observer.observe(post);
  });
}
